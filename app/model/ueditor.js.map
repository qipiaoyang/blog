{
    "version": 3,
    "sources": [
        "..\\..\\src\\model\\ueditor.js"
    ],
    "names": [
        "path",
        "require",
        "fs",
        "superagent",
        "module",
        "exports",
        "think",
        "Service",
        "constructor",
        "fileField",
        "config",
        "type",
        "http",
        "saveRemote",
        "upBase64",
        "upFile",
        "file",
        "console",
        "log",
        "isFile",
        "stateInfo",
        "oriName",
        "name",
        "fileSize",
        "size",
        "fileType",
        "getFileExt",
        "fullName",
        "getFullName",
        "filePath",
        "getFilePath",
        "fileName",
        "getFileName",
        "mkdir",
        "replace",
        "checkSize",
        "checkType",
        "renameSync",
        "base64Data",
        "post",
        "img",
        "Buffer",
        "from",
        "length",
        "writeFileSync",
        "spiderImage",
        "imgUrl",
        "deferred",
        "defer",
        "get",
        "end",
        "req",
        "res",
        "body",
        "resolve",
        "promise",
        "indexOf",
        "m",
        "match",
        "promises",
        "extname",
        "self",
        "format",
        "pathFormat",
        "d",
        "Date",
        "t",
        "getTime",
        "date",
        "yyyy",
        "getFullYear",
        "mm",
        "getMonth",
        "dd",
        "getDate",
        "str",
        "index",
        "search",
        "charAt",
        "rand",
        "Math",
        "random",
        "toString",
        "substr",
        "ext",
        "resource",
        "basename",
        "_",
        "includes",
        "getFileInfo"
    ],
    "mappings": "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",
    "file": "..\\..\\src\\model\\ueditor.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\r\n// | CmsWing [ 网站内容管理框架 ]\r\n// +----------------------------------------------------------------------\r\n// | Copyright (c) 2015-2115 http://www.cmswing.com All rights reserved.\r\n// +----------------------------------------------------------------------\r\n// | Author: arterli <arterli@qq.com>\r\n// +----------------------------------------------------------------------\r\n\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst superagent = require('superagent');\r\nmodule.exports = class extends think.Service {\r\n  /**\r\n     * init\r\n     * @return {[]}         []\r\n     */\r\n  constructor(fileField, config, type, http) {\r\n    super(http);\r\n    type = type || 'upload';\r\n    // super.init(http);\r\n    this.http = http;\r\n    this.fileField = fileField;\r\n    this.config = config;\r\n    this.type = type;\r\n    // console.log(fileField);\r\n    // console.log(http);\r\n    if (type === 'remote') {\r\n      this.saveRemote();\r\n    } else if (type === 'base64') {\r\n      this.upBase64();\r\n    } else {\r\n      this.upFile();\r\n    }\r\n  }\r\n\r\n  /**\r\n     * 上传文件的主处理方法\r\n     * @return mixed\r\n     */\r\n  upFile() {\r\n    const http = this.http;\r\n    const file = http.file(this.fileField);\r\n    console.log(file);\r\n    if (!think.isFile(file.path)) {\r\n      this.stateInfo = '找不到临时文件';\r\n      return;\r\n    }\r\n\r\n    this.oriName = file.name;\r\n    this.fileSize = file.size;\r\n    this.fileType = this.getFileExt;\r\n    this.fullName = this.getFullName;\r\n    this.filePath = this.getFilePath;\r\n    this.fileName = this.getFileName;\r\n    think.mkdir(this.filePath.replace(this.fileName, ''));\r\n    // 检查文件大小是否超出限制\r\n    if (!this.checkSize) {\r\n      this.stateInfo = '文件大小超出网站限制';\r\n      return;\r\n    }\r\n    // 检查是否不允许的文件格式\r\n    if (!this.checkType) {\r\n      this.stateInfo = '文件类型不允许';\r\n      return;\r\n    }\r\n    // 移动文件\r\n    fs.renameSync(file.path, this.filePath);\r\n    if (think.isFile(this.filePath)) {\r\n      this.stateInfo = 'SUCCESS';\r\n    } else {\r\n      this.stateInfo = '文件保存时出错';\r\n    }\r\n  }\r\n  /**\r\n     * 处理base64编码的图片上传\r\n     * @return mixed\r\n     */\r\n  upBase64() {\r\n    const http = this.http;\r\n    const base64Data = http.post(this.fileField);\r\n    // console.log(base64Data);\r\n    const img = Buffer.from(base64Data, 'base64');\r\n    // console.log(img);\r\n    this.oriName = this.config['oriName'];\r\n    // console.log(this.oriName);\r\n    this.fileSize = img.length;\r\n    this.fileType = this.getFileExt;\r\n    this.fullName = this.getFullName;\r\n    this.filePath = this.getFilePath;\r\n    this.fileName = this.getFileName;\r\n    think.mkdir(this.filePath.replace(this.fileName, ''));\r\n\r\n    // 检查文件大小是否超出限制\r\n    // if (!this.checkSize()) {\r\n    //  this.stateInfo = \"文件大小超出网站限制\";\r\n    //  return;\r\n    // }\r\n    /// /检查是否不允许的文件格式\r\n    // if (!this.checkType()) {\r\n    //  this.stateInfo = \"文件类型不允许\";\r\n    //  return;\r\n    // }\r\n    // 移动文件\r\n    // fs.renameSync(img, this.filePath);\r\n    fs.writeFileSync(this.filePath, img);\r\n    if (think.isFile(this.filePath)) {\r\n      this.stateInfo = 'SUCCESS';\r\n    } else {\r\n      this.stateInfo = '文件保存时出错';\r\n    }\r\n  }\r\n\r\n  spiderImage(imgUrl, filePath) {\r\n    const deferred = think.defer();\r\n    superagent\r\n      .get(imgUrl) // 这里的URL也可以是绝对路径\r\n      .end(function(req, res) {\r\n        fs.writeFileSync(filePath, res.body);\r\n        deferred.resolve(filePath);\r\n      });\r\n    return deferred.promise;\r\n  }\r\n  /**\r\n     * 拉取远程图片\r\n     * @return mixed\r\n     */\r\n  async saveRemote() {\r\n    // think.log(\"dddddd\")\r\n    const imgUrl = this.fileField;\r\n    // imgUrl = imgUrl.replace(/&amp;/,\"&\");\r\n    // http开头验证\r\n    if (imgUrl.indexOf('http') !== 0) {\r\n      this.stateInfo = '链接不是http链接';\r\n      return;\r\n    }\r\n    // TODO 各种验证后面弄\r\n    const m = imgUrl.match(/[\\/]([^\\/]*)[\\.]?[^\\.\\/]*$/)[1];\r\n    this.oriName = m || '';\r\n    // console.log(this.oriName);\r\n    this.fileSize = imgUrl.length;// TODO 这里有问题，后面弄\r\n    this.fileType = this.getFileExt;\r\n    this.fullName = this.getFullName;\r\n    this.filePath = this.getFilePath;\r\n    this.fileName = this.getFileName;\r\n    const filePath = this.filePath;\r\n    const fullName = this.fullName;\r\n    think.mkdir(this.filePath.replace(this.fileName, ''));\r\n    const promises = await this.spiderImage(imgUrl, filePath);\r\n    // console.log(promises);\r\n    if (think.isFile(promises)) {\r\n      this.stateInfo = 'SUCCESS';\r\n    } else {\r\n      this.stateInfo = '文件保存时出错';\r\n    }\r\n    return {\r\n      'state': this.stateInfo,\r\n      'url': this.fullName,\r\n      'title': this.fileName,\r\n      'original': this.oriName,\r\n      'type': this.fileType,\r\n      'size': this.fileSize\r\n    };\r\n  }\r\n\r\n  /**\r\n     * 获取文件扩展名\r\n     * @return string\r\n     */\r\n  get getFileExt() {\r\n    return path.extname(this.oriName);\r\n  }\r\n\r\n  /**\r\n     * 重命名文件\r\n     * @return string\r\n     */\r\n  get getFullName() {\r\n    // 替换目录日期事件\r\n    /// ueditor/php/upload/image/{yyyy}{mm}{dd}/{time}{rand:6}\r\n    var self = this;\r\n    // var filename= this.filed;\r\n    var format = this.config.pathFormat;\r\n    var d = new Date();\r\n    var t = d.getTime();\r\n    var date = {};\r\n    date.yyyy = d.getFullYear();\r\n    date.mm = (d.getMonth() + 1) < 10 ? '0' + (d.getMonth() + 1) : d.getMonth() + 1;\r\n    date.dd = (d.getDate() < 10 ? '0' : '') + d.getDate();\r\n    format = format.replace('{yyyy}', date.yyyy);\r\n    format = format.replace('{mm}', date.mm);\r\n    format = format.replace('{dd}', date.dd);\r\n    format = format.replace('{time}', t);\r\n    // 计算随机数\r\n    var str = format.match(/\\{rand\\:[\\d]*\\}/i);\r\n    var index = str[0].search(/:/) + 1;\r\n    index = str[0].charAt(index);\r\n    var rand = Math.random();\r\n    rand = rand.toString();\r\n    rand = rand.substr(2, index);\r\n    // 替换随机数\r\n    format = format.replace(str[0], rand);\r\n    var ext = this.getFileExt;\r\n    return format + ext;\r\n  }\r\n\r\n  /**\r\n     * 获取文件完整路径\r\n     * @return string\r\n     */\r\n  get getFilePath() {\r\n    if (this.fullName.substr(0, 1) != '/') {\r\n      this.fullName = '/' + this.fullName;\r\n    }\r\n\r\n    return think.resource + this.fullName;\r\n  }\r\n  /**\r\n     * 获取文件名\r\n     * @return string\r\n     */\r\n  get getFileName() {\r\n    return path.basename(this.filePath);\r\n  }\r\n\r\n  /**\r\n     * 文件类型检测\r\n     * @return bool\r\n     */\r\n  get checkType() {\r\n    return think._.includes(this.config['allowFiles'], this.getFileExt);\r\n  }\r\n\r\n  /**\r\n     * 文件大小检测\r\n     * @return bool\r\n     */\r\n  get checkSize() {\r\n    return this.fileSize <= (this.config['maxSize']);\r\n  }\r\n  /**\r\n     * 获取当前上传成功文件的各项信息\r\n     * @return array\r\n     */\r\n  get getFileInfo() {\r\n    return {\r\n      'state': this.stateInfo,\r\n      'url': this.fullName,\r\n      'title': this.fileName,\r\n      'original': this.oriName,\r\n      'type': this.fileType,\r\n      'size': this.fileSize\r\n    };\r\n  }\r\n};\r\n"
    ]
}